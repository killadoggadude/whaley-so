{"version":3,"sources":["../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../src/app/dashboard/tools/prompts/actions.ts","../../../../.next-internal/server/app/dashboard/tools/prompts/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport type { Prompt, PromptWithSourceImage, Asset, AssetWithUrl } from \"@/types\";\n\nexport async function savePromptsAction(\n  prompts: {\n    model_id: string | null;\n    source_image_id: string | null;\n    prompt_text: string;\n    prompt_index: number;\n    variation_label: string;\n    metadata?: Record<string, unknown>;\n  }[]\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const supabase = await createClient();\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Not authenticated\" };\n\n    const rows = prompts.map((p) => ({\n      user_id: user.id,\n      model_id: p.model_id,\n      source_image_id: p.source_image_id,\n      prompt_text: p.prompt_text,\n      prompt_index: p.prompt_index,\n      variation_label: p.variation_label,\n      metadata: p.metadata || {},\n    }));\n\n    const { error } = await supabase.from(\"prompts\").insert(rows);\n\n    if (error) return { success: false, error: error.message };\n\n    revalidatePath(\"/dashboard/tools/prompts\");\n    return { success: true };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Failed to save prompts\",\n    };\n  }\n}\n\nexport async function getPromptsAction(filters?: {\n  limit?: number;\n  offset?: number;\n}): Promise<{\n  prompts: PromptWithSourceImage[];\n  total: number;\n  error?: string;\n}> {\n  try {\n    const supabase = await createClient();\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return { prompts: [], total: 0, error: \"Not authenticated\" };\n\n    let query = supabase\n      .from(\"prompts\")\n      .select(\"*\", { count: \"exact\" })\n      .eq(\"user_id\", user.id);\n\n    query = query.order(\"created_at\", { ascending: false });\n\n    const limit = filters?.limit || 30;\n    const offset = filters?.offset || 0;\n    query = query.range(offset, offset + limit - 1);\n\n    const { data, error, count } = await query;\n\n    if (error) return { prompts: [], total: 0, error: error.message };\n\n    const rawPrompts: Prompt[] = data || [];\n\n    // Collect unique source_image_id values\n    const sourceImageIds = [\n      ...new Set(\n        rawPrompts\n          .map((p) => p.source_image_id)\n          .filter((id): id is string => id !== null)\n      ),\n    ];\n\n    // Batch-fetch source image assets and generate signed URLs\n    const sourceImageMap = new Map<string, AssetWithUrl>();\n\n    if (sourceImageIds.length > 0) {\n      const { data: assets } = await supabase\n        .from(\"assets\")\n        .select(\"*\")\n        .in(\"id\", sourceImageIds);\n\n      if (assets && assets.length > 0) {\n        // Generate signed URLs in batch\n        const signedPaths = assets.map((a: Asset) => a.file_path);\n        const { data: signedUrls } = await supabase.storage\n          .from(\"assets\")\n          .createSignedUrls(signedPaths, 3600);\n\n        for (let i = 0; i < assets.length; i++) {\n          const asset = assets[i] as Asset;\n          const signedUrl = signedUrls?.[i]?.signedUrl || \"\";\n          sourceImageMap.set(asset.id, { ...asset, signed_url: signedUrl });\n        }\n      }\n    }\n\n    // Map to PromptWithSourceImage with resolved source images\n    const prompts: PromptWithSourceImage[] = rawPrompts.map(\n      (prompt: Prompt) => ({\n        ...prompt,\n        source_image: prompt.source_image_id\n          ? sourceImageMap.get(prompt.source_image_id)\n          : undefined,\n      })\n    );\n\n    return { prompts, total: count || 0 };\n  } catch (error) {\n    return {\n      prompts: [],\n      total: 0,\n      error: error instanceof Error ? error.message : \"Failed to fetch prompts\",\n    };\n  }\n}\n\nexport async function updatePromptAction(\n  promptId: string,\n  promptText: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const supabase = await createClient();\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Not authenticated\" };\n\n    const { error } = await supabase\n      .from(\"prompts\")\n      .update({ prompt_text: promptText, is_edited: true })\n      .eq(\"id\", promptId)\n      .eq(\"user_id\", user.id);\n\n    if (error) return { success: false, error: error.message };\n\n    revalidatePath(\"/dashboard/tools/prompts\");\n    return { success: true };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Failed to update prompt\",\n    };\n  }\n}\n\nexport async function deletePromptAction(\n  promptId: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const supabase = await createClient();\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return { success: false, error: \"Not authenticated\" };\n\n    const { error } = await supabase\n      .from(\"prompts\")\n      .delete()\n      .eq(\"id\", promptId)\n      .eq(\"user_id\", user.id);\n\n    if (error) return { success: false, error: error.message };\n\n    revalidatePath(\"/dashboard/tools/prompts\");\n    return { success: true };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Failed to delete prompt\",\n    };\n  }\n}\n","export {updatePromptAction as '603a2216d6dae2430e450d9d9d8657b8fbef47f05d'} from 'ACTIONS_MODULE0'\nexport {deletePromptAction as '40886c4094dc8e7fa94b50409e37b3bd3c23af2705'} from 'ACTIONS_MODULE0'\nexport {savePromptsAction as '40cc7ce593799f345f22d67d5cee644da005a9b3ab'} from 'ACTIONS_MODULE0'\nexport {getPromptsAction as '4080a7ba85e37fafbc4df09efa7c0c457b39cf3d12'} from 'ACTIONS_MODULE0'\nexport {getPromptsAction as '4080a7ba85e37fafbc4df09efa7c0c457b39cf3d12'} from 'ACTIONS_MODULE0'\nexport {deletePromptAction as '40886c4094dc8e7fa94b50409e37b3bd3c23af2705'} from 'ACTIONS_MODULE0'\nexport {savePromptsAction as '40cc7ce593799f345f22d67d5cee644da005a9b3ab'} from 'ACTIONS_MODULE0'\nexport {updatePromptAction as '603a2216d6dae2430e450d9d9d8657b8fbef47f05d'} from 'ACTIONS_MODULE0'\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"6CAAoD,OAAA,cAAA,CAAA,EAAA,aAAA,oCAC3CA,0BAAAA,qCAAAA,EAAAA,uBAAuB,YAAQ,CAAA,CAAA,IAAA,iCCEjC,SAASC,EAAyBC,CAAc,EACrD,IAAK,IAAIC,EAAI,EAAGA,EAAID,EAAQE,MAAM,CAAED,IAAK,CACvC,IAAME,EAASH,CAAO,CAACC,EAAE,CACzB,GAAI,AAAkB,YAAY,OAAvBE,EACT,MAAM,OAAA,cAEL,CAFK,AAAIC,MACR,CAAC,2DAA2D,EAAE,OAAOD,EAAO;AAAA,oEAAuE,CAAC,EADhJ,oBAAA,OAAA,mBAAA,gBAAA,CAEN,EAEJ,CACF,0EATgBJ,2BAAAA,qCAAAA,8CCDhB,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAGO,eAAe,EACpB,CAOG,EAEH,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,CACJ,KAAM,MAAE,CAAI,CAAE,CACf,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,CAAC,EAAM,MAAO,CAAE,SAAS,EAAO,MAAO,mBAAoB,EAE/D,IAAM,EAAO,EAAQ,GAAG,CAAC,AAAC,IAAM,AAAC,CAC/B,QAAS,EAAK,EAAE,CAChB,SAAU,EAAE,QAAQ,CACpB,gBAAiB,EAAE,eAAe,CAClC,YAAa,EAAE,WAAW,CAC1B,aAAc,EAAE,YAAY,CAC5B,gBAAiB,EAAE,eAAe,CAClC,SAAU,EAAE,QAAQ,EAAI,CAAC,EAC3B,CAAC,EAEK,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,WAAW,MAAM,CAAC,GAExD,GAAI,EAAO,MAAO,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,EAGzD,MADA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,4BACR,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAO,CACd,MAAO,CACL,SAAS,EACT,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,wBAClD,CACF,CACF,CAEO,eAAe,EAAiB,CAGtC,EAKC,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,CACJ,KAAM,CAAE,MAAI,CAAE,CACf,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,CAAC,EAAM,MAAO,CAAE,QAAS,EAAE,CAAE,MAAO,EAAG,MAAO,mBAAoB,EAEtE,IAAI,EAAQ,EACT,IAAI,CAAC,WACL,MAAM,CAAC,IAAK,CAAE,MAAO,OAAQ,GAC7B,EAAE,CAAC,UAAW,EAAK,EAAE,EAExB,EAAQ,EAAM,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,GAErD,IAAM,EAAQ,GAAS,OAAS,GAC1B,EAAS,GAAS,QAAU,EAClC,EAAQ,EAAM,KAAK,CAAC,EAAQ,EAAS,EAAQ,GAE7C,GAAM,MAAE,CAAI,OAAE,CAAK,CAAE,OAAK,CAAE,CAAG,MAAM,EAErC,GAAI,EAAO,MAAO,CAAE,QAAS,EAAE,CAAE,MAAO,EAAG,MAAO,EAAM,OAAO,AAAC,EAEhE,IAAM,EAAuB,GAAQ,EAAE,CAGjC,EAAiB,IAClB,IAAI,IACL,EACG,GAAG,CAAC,AAAC,GAAM,EAAE,eAAe,EAC5B,MAAM,CAAE,AAAD,GAA6B,OAAP,IAEnC,CAGK,EAAiB,IAAI,IAE3B,GAAI,EAAe,MAAM,CAAG,EAAG,CAC7B,GAAM,CAAE,KAAM,CAAM,CAAE,CAAG,MAAM,EAC5B,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,KAAM,GAEZ,GAAI,GAAU,EAAO,MAAM,CAAG,EAAG,CAE/B,IAAM,EAAc,EAAO,GAAG,CAAC,AAAC,GAAa,EAAE,SAAS,EAClD,CAAE,KAAM,CAAU,CAAE,CAAG,MAAM,EAAS,OAAO,CAChD,IAAI,CAAC,UACL,gBAAgB,CAAC,EAAa,MAEjC,IAAK,IAAI,EAAI,EAAG,EAAI,EAAO,MAAM,CAAE,IAAK,CACtC,IAAM,EAAQ,CAAM,CAAC,EAAE,CACjB,EAAY,GAAY,CAAC,EAAE,EAAE,WAAa,GAChD,EAAe,GAAG,CAAC,EAAM,EAAE,CAAE,CAAE,GAAG,CAAK,CAAE,WAAY,CAAU,EACjE,CACF,CACF,CAYA,MAAO,CAAE,QATgC,EAAW,GAAG,CACrD,AAAC,IAAoB,CACnB,GAAG,CADe,AACT,CACT,aAAc,EAAO,eAAe,CAChC,EAAe,GAAG,CAAC,EAAO,eAAe,OACzC,EACN,CAAC,EAGe,MAAO,GAAS,CAAE,CACtC,CAAE,MAAO,EAAO,CACd,MAAO,CACL,QAAS,EAAE,CACX,MAAO,EACP,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,yBAClD,CACF,CACF,CAEO,eAAe,EACpB,CAAgB,CAChB,CAAkB,EAElB,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,CACJ,KAAM,MAAE,CAAI,CAAE,CACf,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,CAAC,EAAM,MAAO,CAAE,SAAS,EAAO,MAAO,mBAAoB,EAE/D,GAAM,OAAE,CAAK,CAAE,CAAG,MAAM,EACrB,IAAI,CAAC,WACL,MAAM,CAAC,CAAE,YAAa,EAAY,WAAW,CAAK,GAClD,EAAE,CAAC,KAAM,GACT,EAAE,CAAC,UAAW,EAAK,EAAE,EAExB,GAAI,EAAO,MAAO,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,EAGzD,MADA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,4BACR,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAO,CACd,MAAO,CACL,SAAS,EACT,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,yBAClD,CACF,CACF,CAEO,eAAe,EACpB,CAAgB,EAEhB,GAAI,CACF,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAC7B,CACJ,KAAM,MAAE,CAAI,CAAE,CACf,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAE/B,GAAI,CAAC,EAAM,MAAO,CAAE,SAAS,EAAO,MAAO,mBAAoB,EAE/D,GAAM,CAAE,OAAK,CAAE,CAAG,MAAM,EACrB,IAAI,CAAC,WACL,MAAM,GACN,EAAE,CAAC,KAAM,GACT,EAAE,CAAC,UAAW,EAAK,EAAE,EAExB,GAAI,EAAO,MAAO,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,EAGzD,MADA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,4BACR,CAAE,QAAS,EAAK,CACzB,CAAE,MAAO,EAAO,CACd,MAAO,CACL,SAAS,EACT,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,yBAClD,CACF,CACF,0CAzLsB,EA0CA,EAsFA,EA8BA,IA9JA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA0CA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAsFA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA8BA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,8ICpKtB,IAAA,EAAA,EAAA,CAAA,CAAA","ignoreList":[0,1]}