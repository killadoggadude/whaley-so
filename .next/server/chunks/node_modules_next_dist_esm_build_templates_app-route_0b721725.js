module.exports=[15238,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),o=e.i(59756),n=e.i(61916),i=e.i(74677),l=e.i(69741),s=e.i(16795),c=e.i(87718),d=e.i(95169),u=e.i(47587),p=e.i(66012),m=e.i(70101),f=e.i(26937),g=e.i(10372),h=e.i(93695);e.i(52474);var R=e.i(5232),v=e.i(89171),w=e.i(26500),x=e.i(33405),E=e.i(24868),y=e.i(14747),T=e.i(46786);async function U(){let t=[(0,y.join)(process.cwd(),"node_modules","ffmpeg-static","ffmpeg"),(0,y.join)(process.cwd(),"..","node_modules","ffmpeg-static","ffmpeg"),"/usr/local/bin/ffmpeg","/usr/bin/ffmpeg","ffmpeg"];for(let e of t)try{return await (0,E.access)(e),e}catch{}try{let t=e.r(9e3);if(t)return t}catch{}throw Error("FFmpeg binary not found. Searched: "+t.join(", "))}async function F(e){console.log("[ExtractFrame] Resolving Instagram URL:",e);let t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9"},redirect:"follow"});if(!t.ok)throw Error(`Failed to fetch Instagram page: HTTP ${t.status}`);let r=await t.text(),a=r.match(/og:video:secure_url"\s*content="([^"]+)"/);if(a||(a=r.match(/og:video"\s*content="([^"]+)"/)),!a||!a[1])throw Error("Could not find video URL in Instagram page. The reel may be private or the URL may be invalid.");let o=a[1].replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');return console.log("[ExtractFrame] Resolved Instagram video URL:",o.slice(0,120)+"..."),o}async function C(e){console.log("[ExtractFrame] Resolving TikTok URL:",e);let t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"},redirect:"follow"});if(!t.ok)throw Error(`Failed to fetch TikTok page: HTTP ${t.status}`);let r=await t.text(),a=r.match(/og:video:secure_url"\s*content="([^"]+)"/);if(a||(a=r.match(/og:video"\s*content="([^"]+)"/)),a||(a=r.match(/"downloadAddr":"([^"]+)"/)),!a||!a[1])throw Error("Could not find video URL in TikTok page. The video may be private or the URL may be invalid.");let o=a[1].replace(/&amp;/g,"&").replace(/\\u002F/g,"/").replace(/\\\//g,"/");return console.log("[ExtractFrame] Resolved TikTok video URL:",o.slice(0,120)+"..."),o}async function A(e){return e.includes("instagram.com")||e.includes("instagr.am")?F(e):e.includes("tiktok.com")?C(e):e}async function k(t){let r=null;try{let e=await (0,w.createClient)(),{data:{user:a}}=await e.auth.getUser();if(!a)return v.NextResponse.json({error:"Unauthorized"},{status:401});let{videoUrl:o}=await t.json();if(!o)return v.NextResponse.json({error:"videoUrl is required"},{status:400});let n=o;if(o.includes("instagram.com")||o.includes("instagr.am")||o.includes("tiktok.com"))try{n=await A(o)}catch(e){return v.NextResponse.json({error:e instanceof Error?e.message:"Failed to resolve video URL. Try uploading the video directly instead."},{status:400})}console.log("[ExtractFrame] Downloading video...");let i=await fetch(n,{headers:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"}});if(!i.ok)return v.NextResponse.json({error:`Failed to download video: HTTP ${i.status}. Try uploading the video directly.`},{status:500});let l=Buffer.from(await i.arrayBuffer()),s=i.headers.get("content-type")||"video/mp4";if(s.includes("text/html")||l.length<5e3)return v.NextResponse.json({error:"The URL did not return a valid video file. Try uploading the video directly instead."},{status:400});let c=s.includes("webm")?"webm":"mp4";console.log(`[ExtractFrame] Downloaded ${(l.length/1024/1024).toFixed(1)}MB video (${s})`);let d=crypto.randomUUID(),u=`motion-ref_${d.slice(0,8)}.${c}`,p=`${a.id}/video/${d}_${u}`,{error:m}=await e.storage.from("assets").upload(p,l,{contentType:s.includes("video")?s:"video/mp4",upsert:!1});m&&console.error("[ExtractFrame] Video upload error:",m.message);let f=null;if(!m){let{data:t}=await e.storage.from("assets").createSignedUrl(p,3600);f=t?.signedUrl||null}r=await (0,E.mkdtemp)((0,y.join)((0,T.tmpdir)(),"motion-frame-"));let g=(0,y.join)(r,`input.${c}`),h=(0,y.join)(r,"frame.jpg");await (0,E.writeFile)(g,l);let R=await U();await new Promise((e,t)=>{let r=["-i",g,"-frames:v","1","-q:v","2","-y",h];console.log("[ExtractFrame] Running FFmpeg:",r.join(" ")),(0,x.execFile)(R,r,{timeout:3e4},(r,a,o)=>{r?(console.error("[ExtractFrame] FFmpeg error:",r.message),console.error("[ExtractFrame] FFmpeg stderr:",o),t(Error(`FFmpeg frame extraction failed: ${r.message}`))):e()})});let F=await (0,E.readFile)(h),C=crypto.randomUUID(),k=`motion-frame_${C.slice(0,8)}.jpg`,P=`${a.id}/image/${C}_${k}`,{error:b}=await e.storage.from("assets").upload(P,F,{contentType:"image/jpeg",upsert:!1});if(b)return v.NextResponse.json({error:`Frame upload failed: ${b.message}`},{status:500});let{data:S}=await e.storage.from("assets").createSignedUrl(P,3600);if(!S?.signedUrl)return v.NextResponse.json({error:"Failed to create signed URL for frame"},{status:500});return console.log("[ExtractFrame] Frame extracted and uploaded:",P),v.NextResponse.json({frameUrl:S.signedUrl,resolvedVideoUrl:f||n,filePath:P,fileSize:F.length})}catch(e){return console.error("Extract frame error:",e),v.NextResponse.json({error:e instanceof Error?e.message:"Failed to extract frame"},{status:500})}finally{if(r)try{for(let e of["input.mp4","input.webm","frame.jpg"])try{await (0,E.unlink)((0,y.join)(r,e))}catch{}let{rmdir:t}=await e.A(60815);await t(r)}catch{}}}e.s(["POST",()=>k,"maxDuration",0,120],80282);var P=e.i(80282);let b=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/motion-control/extract-frame/route",pathname:"/api/motion-control/extract-frame",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/motion-control/extract-frame/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:S,workUnitAsyncStorage:N,serverHooks:_}=b;function j(){return(0,a.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:N})}async function O(e,t,a){b.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/motion-control/extract-frame/route";v=v.replace(/\/index$/,"")||"/";let w=await b.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:x,params:E,nextConfig:y,parsedUrl:T,isDraftMode:U,prerenderManifest:F,routerServerContext:C,isOnDemandRevalidate:A,revalidateOnlyGenerated:k,resolvedPathname:P,clientReferenceManifest:S,serverActionsManifest:N}=w,_=(0,l.normalizeAppPath)(v),j=!!(F.dynamicRoutes[_]||F.routes[P]),O=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,T,!1):t.end("This page could not be found"),null);if(j&&!U){let e=!!F.routes[P],t=F.dynamicRoutes[_];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await O();throw new h.NoFallbackError}}let $=null;!j||b.isDev||U||($="/index"===($=P)?"/":$);let M=!0===b.isDev||!j,H=j&&!M;N&&S&&(0,i.setManifestsSingleton)({page:v,clientReferenceManifest:S,serverActionsManifest:N});let q=e.method||"GET",I=(0,n.getTracer)(),L=I.getActiveScopeSpan(),D={params:E,prerenderManifest:F,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,o)=>b.onRequestError(e,t,a,o,C)},sharedContext:{buildId:x}},K=new s.NodeNextRequest(e),B=new s.NodeNextResponse(t),V=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let i=async e=>b.handle(V,D).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=I.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${v}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),s=async o=>{var n,s;let c=async({previousCacheEntry:r})=>{try{if(!l&&A&&k&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(o);e.fetchMetrics=D.renderOpts.fetchMetrics;let s=D.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let c=D.renderOpts.collectedTags;if(!j)return await (0,p.sendResponse)(K,B,n,D.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==D.renderOpts.collectedRevalidate&&!(D.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&D.renderOpts.collectedRevalidate,a=void 0===D.renderOpts.collectedExpire||D.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:D.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},!1,C),t}},d=await b.handleResponse({req:e,nextConfig:y,cacheKey:$,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:F,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:k,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:l});if(!j)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(s=d.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),U&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&j||h.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,B,new Response(d.value.body,{headers:h,status:d.value.status||200})),null};L?await s(L):await I.withPropagatedContext(e.headers,()=>I.trace(d.BaseServerSpan.handleRequest,{spanName:`${q} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},s))}catch(t){if(t instanceof h.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},!1,C),j)throw t;return await (0,p.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>j,"routeModule",()=>b,"serverHooks",()=>_,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>N],15238)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_0b721725.js.map